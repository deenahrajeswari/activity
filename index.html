<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MY To-Do list ❤️</title>
  <link href="style.css" rel="stylesheet">
</head>

<body>
  <div class="container">

    <div class="todolist">
      <h1>
        <img src="icon.jpeg" alt="icon" class="logo"> TO-DO LIST
      </h1>

      <!-- Login/Register -->
      <div id="authContainer">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button id="registerBtn">Register</button>
        <button id="loginBtn">Login</button>
      </div>

      <!-- Task Box (hidden until user logs in) -->
      <div class="task-box" id="taskBox" style="display:none;">
        <div class="input-row">
          <input type="text" id="taskInput" placeholder="Enter a task">
          <button id="addBtn">Add</button>
        </div>

        <div class="row tasks-and-motivation">
          <ul id="taskList"></ul>

          <div class="motivation">
            <img src="mot.jpeg" alt="Motivational Image">
          </div>

        </div>

        <img id="victoryImg" src="victory.jpeg" alt="Victory!">

        <button id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBoW7a3NWL0DS5ynJymIrr0gP1hdIa6SXY",
    authDomain: "my-to-d0.firebaseapp.com",
    projectId: "my-to-d0",
    storageBucket: "my-to-d0.appspot.com",
    messagingSenderId: "820680960546",
    appId: "1:820680960546:web:60843763935c4d0790787b"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth();

  // DOM elements
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const registerBtn = document.getElementById("registerBtn");
  const loginBtn = document.getElementById("loginBtn");
  const authContainer = document.getElementById("authContainer");

  const taskBox = document.getElementById("taskBox");
  const taskInput = document.getElementById("taskInput");
  const addBtn = document.getElementById("addBtn");
  const taskList = document.getElementById("taskList");
  const victoryImg = document.getElementById("victoryImg");
  const logoutBtn = document.getElementById("logoutBtn");

  // Register
  registerBtn.addEventListener("click", async () => {
    try {
      await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
      alert("Registered and logged in!");
    } catch (err) {
      alert(err.message);
    }
  });

  // Login
  loginBtn.addEventListener("click", async () => {
    try {
      await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
      alert("Login successful!");
    } catch (err) {
      alert(err.message);
    }
  });

  // Logout
  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    alert("Logged out!");
  });

  // Auth state observer
  onAuthStateChanged(auth, user => {
    if (user) {
      authContainer.style.display = "none";
      taskBox.style.display = "block";
      taskInput.focus();

      // User-specific collection
      const userTasksCol = collection(db, "tasks", user.uid);

      // Real-time listener
      onSnapshot(userTasksCol, snapshot => {
        taskList.innerHTML = "";
        snapshot.forEach(docSnap => {
          const task = docSnap.data();
          const li = document.createElement("li");
          li.dataset.id = docSnap.id;

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = task.completed;
          checkbox.classList.add("task-checkbox");

          const span = document.createElement("span");
          span.textContent = task.text;
          span.classList.add("task-text");
          if (task.completed) span.classList.add("completed");

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "X";
          deleteBtn.classList.add("deleteBtn");

          li.append(checkbox, span, deleteBtn);
          taskList.appendChild(li);
        });
        checkVictory();
      });

    } else {
      authContainer.style.display = "block";
      taskBox.style.display = "none";
    }
  });

  // Add task
  addBtn.addEventListener("click", async () => {
    const text = taskInput.value.trim();
    if (!text) return;
    const user = auth.currentUser;
    if (!user) return alert("Login first!");

    try {
      await addDoc(collection(db, "tasks", user.uid), {
        text,
        completed: false,
        createdAt: serverTimestamp()
      });
      taskInput.value = "";
    } catch (err) {
      console.error("Error adding task:", err);
      alert("Error adding task!");
    }
  });

  // Complete/Delete task
  taskList.addEventListener("click", async e => {
    const li = e.target.closest("li");
    if (!li) return;
    const id = li.dataset.id;
    const user = auth.currentUser;
    if (!user) return;

    try {
      if (e.target.classList.contains("deleteBtn")) {
        await deleteDoc(doc(db, "tasks", user.uid, id));
      }
      if (e.target.classList.contains("task-checkbox")) {
        const isCompleted = e.target.checked;
        const span = li.querySelector('.task-text');
        if (isCompleted) span.classList.add("completed");
        else span.classList.remove("completed");
        await updateDoc(doc(db, "tasks", user.uid, id), { completed: isCompleted });
        checkVictory();
      }
    } catch (err) {
      console.error(err);
      alert("Error updating task!");
    }
  });

  // Enter key adds task
  taskInput.addEventListener("keypress", e => {
    if (e.key === "Enter") addBtn.click();
  });

  // Victory check
  function checkVictory() {
    const tasks = document.querySelectorAll('#taskList li');
    const completed = document.querySelectorAll('#taskList li .task-checkbox:checked');
    victoryImg.style.display = (tasks.length > 0 && tasks.length === completed.length) ? 'block' : 'none';
  }

</script>

</body>
</html>
