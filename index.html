<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MY To-Do list ‚ù§Ô∏è</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">

    <div class="todolist">
      <h1>
        <img src="icon.jpeg" alt="icon" class="logo"> TO-DO LIST
      </h1>

      <!-- üîë Login/Register -->
      <div id="authContainer">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button id="registerBtn">Register</button>
        <button id="loginBtn">Login</button>
      </div>

      <!-- ‚úÖ Task Box -->
      <div class="task-box" id="taskBox" style="display:none;">
        <div class="input-row">
          <input type="text" id="taskInput" placeholder="Enter a task">
          <button id="addBtn">Add</button>
        </div>

        <div class="row tasks-and-motivation">
          <ul id="taskList"></ul>
          <div class="motivation">
            <img src="mot.jpeg" alt="Motivational Image">
          </div>
        </div>

        <img id="victoryImg" src="victory.jpeg" alt="Victory!">

        <button id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Firebase + JS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot,
      doc, updateDoc, deleteDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    import {
      getAuth, createUserWithEmailAndPassword,
      signInWithEmailAndPassword, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

    /* üîß Your Firebase Config */
    const firebaseConfig = {
      apiKey: "AIzaSyDS3_L4-amgkYhTDDw0i2ZfIsilAay2tK0",
      authDomain: "productivity-3e1fb.firebaseapp.com",
      projectId: "productivity-3e1fb",
      storageBucket: "productivity-3e1fb.firebasestorage.app",
      messagingSenderId: "84252926850",
      appId: "1:84252926850:web:376ff2d83d576feae5659b",
      measurementId: "G-NS56EKE07F"
    };

    // ‚úÖ Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ‚úÖ DOM Elements
    const emailInput  = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const registerBtn = document.getElementById("registerBtn");
    const loginBtn    = document.getElementById("loginBtn");
    const logoutBtn   = document.getElementById("logoutBtn");
    const authContainer = document.getElementById("authContainer");

    const taskBox  = document.getElementById("taskBox");
    const taskInput= document.getElementById("taskInput");
    const addBtn   = document.getElementById("addBtn");
    const taskList = document.getElementById("taskList");
    const victoryImg = document.getElementById("victoryImg");

    /* ================= AUTH ================= */

    registerBtn.addEventListener("click", async () => {
      try {
        await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
        alert("Registered & Logged in!");
      } catch (err) {
        alert(err.message);
      }
    });

    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
        alert("Login successful!");
      } catch (err) {
        alert(err.message);
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      alert("Logged out!");
    });

    /* ================= TASK LOGIC ================= */

    onAuthStateChanged(auth, user => {
      if (user) {
        // Show task box
        authContainer.style.display = "none";
        taskBox.style.display = "block";
        taskInput.focus();

        // ‚úÖ Correct Firestore path:
        // users/{uid}/tasks
        const userTasksCol = collection(db, "users", user.uid, "tasks");

        // Real-time listener
        onSnapshot(userTasksCol, snapshot => {
          taskList.innerHTML = "";
          snapshot.forEach(docSnap => {
            const task = docSnap.data();

            const li = document.createElement("li");
            li.dataset.id = docSnap.id;

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.checked = task.completed;
            checkbox.classList.add("task-checkbox");

            const span = document.createElement("span");
            span.textContent = task.text;
            span.classList.add("task-text");
            if (task.completed) span.classList.add("completed");

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "X";
            deleteBtn.classList.add("deleteBtn");

            li.append(checkbox, span, deleteBtn);
            taskList.appendChild(li);
          });
          checkVictory();
        });

        // Add task
        addBtn.onclick = async () => {
          const text = taskInput.value.trim();
          if (!text) return;
          try {
            await addDoc(userTasksCol, {
              text,
              completed: false,
              createdAt: serverTimestamp()
            });
            taskInput.value = "";
          } catch (err) {
            console.error("Error adding task:", err);
            alert("Error adding task!");
          }
        };

        // Enter key adds task
        taskInput.onkeypress = e => {
          if (e.key === "Enter") addBtn.click();
        };

        // Update/Delete
        taskList.onclick = async e => {
          const li = e.target.closest("li");
          if (!li) return;
          const id = li.dataset.id;

          if (e.target.classList.contains("deleteBtn")) {
            await deleteDoc(doc(db, "users", user.uid, "tasks", id));
          }
          if (e.target.classList.contains("task-checkbox")) {
            const isCompleted = e.target.checked;
            const span = li.querySelector('.task-text');
            span.classList.toggle("completed", isCompleted);
            await updateDoc(doc(db, "users", user.uid, "tasks", id), {
              completed: isCompleted
            });
            checkVictory();
          }
        };

      } else {
        // Hide task box
        authContainer.style.display = "block";
        taskBox.style.display = "none";
      }
    });

    // üéØ Check if all tasks are completed
    function checkVictory() {
      const tasks = document.querySelectorAll('#taskList li');
      const completed = document.querySelectorAll('#taskList li .task-checkbox:checked');
      victoryImg.classList.toggle('show', tasks.length > 0 && tasks.length === completed.length);
    }
  </script>
</body>
</html>
